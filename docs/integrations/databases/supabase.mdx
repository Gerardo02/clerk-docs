---
title: Integrate Supabase with Clerk
description: Learn how to integrate Clerk into your Supabase application.
---

# Integrate Supabase with Clerk

> [!WARNING]
> In order to follow this guide, you should already have a Clerk account and project created, along with a Supabase project. If you haven't already, [create a Supabase project](https://supabase.com/dashboard/projects).

Integrating Supabase with Clerk gives you the benefits of using a Supabase database while leveraging Clerk's authentication, prebuilt components, and webhooks. To get the most out of Supabase with Clerk, you must implement custom [Row Level Security](https://supabase.com/docs/guides/auth/row-level-security) (RLS) policies.

RLS works by validating database queries according to the restrictions defined in the RLS policies applied to the table. This guide will use the prebuilt demo repository that is a simple task management app to walk you through:

- Creating a function in Supabase to parse the Clerk user ID from the authentication token.
- Creating a `user_id` column that defaults to the Clerk user's ID when new records are created.
- Creating policies to restrict what data can be read and inserted.
- Using the Clerk Supabase integration helper in your code to authenticate with Supabase and execute queries.

This integration restricts what data authenticated users can access in the database, but does not synchronize user records between Clerk and Supabase. To send additional data from Clerk to your Supabase database, we recommend using [webhooks](/docs/integrations/webhooks/overview).

For interacting with the Supabase dashboard, you can either use the **Supabase interface** or the **SQL Editor**. The **SQL Editor** is a more direct way to interact with your database, but the **Supabase interface** provides a more user-friendly experience.

<Steps>

### Create a SQL query that checks the user ID

The first step is to create a function named `requesting_user_id()` that will parse the Clerk user ID from the authentication token. This function will be used to set the default value of `user_id` in a table and in the RLS policies to ensure the user can only access their data.

<Tabs items={["Supabase interface", "SQL Editor"]}>
  <Tab>
    1. In the sidebar of your Supabase dashboard, navigate to **Database** > **Functions**.
    1. Select **Create a new function**.
    1. In the **Add a new function** sheet, make the following changes:
        - Set **Name of function** to `requesting_user_id`.
        - Set **Return type** to `text`.
        - Toggle **Show advanced settings** on.
        - Set **Language** to `sql`.
        - Populate the **Definition** with the following sql:
          ```sql
          SELECT NULLIF(
              current_setting('request.jwt.claims', true)::json->>'sub',
              ''
          )::text;
          ```
        - Select **Confirm**.
  </Tab>
  <Tab>
    1. In the sidebar of your [Supabase dashboard](https://supabase.com/dashboard/projects), navigate to **SQL Editor**, then select **New query**. Paste the following into the editor:
        ```sql
        CREATE OR REPLACE FUNCTION requesting_user_id()
        RETURNS TEXT AS $$
            SELECT NULLIF(
                current_setting('request.jwt.claims', true)::json->>'sub',
                ''
            )::text;
        $$ LANGUAGE SQL STABLE;
        ```
    1. To execute the query and create the `requesting_user_id` function, select **Run**.
  </Tab>
</Tabs>

### Create a table and enable RLS on it

Next, you'll create a `tasks` table and enable RLS on that table. The `tasks` table will also contain a `user_id` column that will use the `requesting_user_id()` function as it's default value. This colume will be used in the RLS policies to only return or modify records scoped to the user's account.

> [!WARNING]
> This step will fail if you are using a pre-existing project and the database already has a `tasks` table.

<Tabs items={["Supabase interface", "SQL Editor"]}>
<Tab>

In the left navigation, select **Table Editor** and select **Create a table**. In the sheet that appears in the right, configure the following settings:
  - Name: `tasks`.
  - Toggle on Enable Row Level Security (RLS).
  - Columns:
    | Name | Type | Default value | Primary | Additional settings (Gear icon) |
    | --- | --- | --- | --- | --- |
    | id | int8 | _NULL_ | Checked | Is identity |
    | name | text | | | |
    | is_done | boolean | false |  | |
    | user_id | text | requesting_user_id() |  | |
  - Select **Save**.


</Tab>
<Tab>
To create the `tasks` table and enable RLS on it, run the following two queries:

```sql
-- Create a 'tasks' table
create table tasks(
  id serial primary key,
  name text not null,
  is_done boolean not null default false,
  user_id text not null default requesting_user_id()
);

-- Enable RLS on the table
alter table `tasks` enable row level security;
```
</Tab>
</Tabs>

### Create ID-based RLS policies

Create RLS policies that permit users to modify and read content associated with their user IDs only.

<Tabs items={["Supabase interface", "SQL Editor"]}>
<Tab>
Use the sidebar to navigate to **Authentication** > **Policies**. You'll create four total policies, one for each of the four Policy Commands.

1. Select **New Policy** to create the `SELECT` policy:
    - Name: "Select tasks policy".
    - For **Allowed operation**, select **SELECT**.
    - For **Target roles**, select **authenticated**.
    - For the **USING** expression, paste the following:
    ```sql filename="Supabase policy editor"
    requesting_user_id() = user_id
    ```
1. Select **New Policy** to create the `INSERT` policy:
    - Name: "Insert task policy".
    - For **Allowed operation**, select **INSERT**.
    - For **Target roles**, select **authenticated**.
    - For the **WITH CHECK** expression, paste the following:
    ```sql filename="Supabase policy editor"
    requesting_user_id() = user_id
    ```
1. Select **New Policy** to create the `UPDATE` policy:
    - Name: "Update task policy".
    - For **Allowed operation**, select **UPDATE**.
    - For **Target roles**, select **authenticated**.
    - For the **USING** expression, paste the following:
    ```sql filename="Supabase policy editor"
    requesting_user_id() = user_id
    ```
1. Select **New Policy** to create the `DELETE` policy:
    - Name: "Delete task policy".
    - For **Allowed operation**, select **DELETE**.
    - For **Target roles**, select **authenticated**.
    - For the **USING** expression, paste the following:
    ```sql filename="Supabase policy editor"
    requesting_user_id() = user_id
    ```
</Tab>
<Tab>
In the sidebar, navigate to **SQL Editor**. Run the following queries to add policies for all statements issued on `tasks`:

```sql
-- This policy will enforce that only tasks where the `user_id` matches the Clerk user ID are returned.
CREATE POLICY "Select tasks policy" ON "public"."tasks"
AS PERMISSIVE FOR SELECT
TO authenticated
USING (requesting_user_id() = user_id)

-- This policy will enforce the user_id field on INSERT statements matches the Clerk user ID.
CREATE POLICY "Insert tasks policy" ON "public"."tasks"
AS PERMISSIVE FOR INSERT
TO authenticated
WITH CHECK (requesting_user_id() = user_id)


-- This policy will enforce that only tasks where the `user_id` matches the Clerk user ID can be updated.
CREATE POLICY "Update tasks policy" ON "public"."tasks"
AS PERMISSIVE FOR UPDATE
TO authenticated
USING (requesting_user_id() = user_id)

-- This policy will enforce that only tasks where the `user_id` matches the Clerk user ID can be deleted.
CREATE POLICY "Delete tasks policy" ON "public"."tasks"
AS PERMISSIVE FOR DELETE
TO authenticated
USING (requesting_user_id() = user_id)
```
</Tab>
</Tabs>

### Get your Supabase JWT secret key

To give users access to your data, Supabase's API requires an authentication token. Your Clerk project can generate these authentication tokens, but it needs your Supabase project's JWT secret key first.

To find the JWT secret key:

1. In the Supabase dashboard, select your project.
1. In the sidebar, select **Settings** > **API**. Copy the value in the **JWT Secret** field.
1. Open the [Clerk dashboard](https://dashboard.clerk.com/) in a new tab.

### Create a Supabase JWT template

Clerk's JWT templates allow you to generate a new valid Supabase authentication token for each signed in user. These tokens allow authenticated users to access your data with Supabase's API.

To create a JWT template for Supabase:

1. Open your project in the Clerk Dashboard and navigate to the **JWT Templates** page in the sidebar.
2. Select the **New template** button, then select **Supabase** from the list of options.
3. Configure your template:
    - The value of the **Name** field will be required when using the template in your code. For this tutorial, name it `supabase`.
    - **Signing algorithm** will be `HS256` by default. This algorithm is required to use JWTs with Supabase. [Learn more in their docs](https://supabase.com/docs/guides/resources/glossary#jwt-signing-secret).
    - Under **Signing key**, add the value of your Supabase **JWT secret key** from [the previous step](#get-your-supabase-jwt-secret-key).
    - Leave all other fields at their default settings unless you want to customize them. See [Clerk's JWT template docs](/docs/backend-requests/making/jwt-templates#creating-a-template) to learn what each of them do.
    - Select **Save** from the notification bubble to complete setup.

### Clone and explore the repository

Clone the demo repository and install it's dependencies:

```bash
git clone https://github.com/bmorrisondev/clerk-supabase-integration-demo.git
cd clerk-supabase-integration-demo
npm install
```

Open the project in the code editor of your choice. All relevant code will be in the `src/app/page.tsx` file as shown below. Note the comments with the "ðŸ‘‰" icon as they point out code of interest.

The `createClerkSupabaseClient()` function in the code is what will be used to inject the Clerk Supabase token into the request headers sent to Supabase. The `requesting_user_id()` function that was created in Supabase will parse this token to use it when querying data from the `tasks` table in Supabase.

```tsx filename="src/app/page.tsx"
'use client'
import { useEffect, useState } from "react";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { FiCheckCircle, FiCircle } from "react-icons/fi";
import { DeleteIcon } from "lucide-react";
import { useUser } from "@clerk/nextjs";
import { createClient } from "@supabase/supabase-js";

// ðŸ‘‰ Register the `Clerk` object  the global window fix TypeScript errors
declare global {
  interface Window {
    Clerk: any;
  }
}

// ðŸ‘‰ Create a custom supabase client that injects the Clerk Supabase token into the request headers
function createClerkSupabaseClient() {
  return createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_KEY!,
    {
      global: {
        // ðŸ‘‰ Get the Supabase token with a custom fetch method
        fetch: async (url, options = {}) => {
          const clerkToken = await window.Clerk.session?.getToken({
            template: "supabase",
          });

          // ðŸ‘‰ Insert the Clerk Supabase token into the headers
          const headers = new Headers(options?.headers);
          headers.set("Authorization", `Bearer ${clerkToken}`);

          // ðŸ‘‰ Now call the default fetch
          return fetch(url, {
            ...options,
            headers,
          });
        },
      },
    }
  );
}

// ðŸ‘‰ Create a `client` object for accessing Supabase data using the Clerk token
const client = createClerkSupabaseClient();

export default   function Home() {
  const [tasks, setTasks] = useState<any[]>([])
  const [name, setName] = useState('')
  // ðŸ‘‰ The `useUser` hook will be used to ensure that Clerk has loaded data about the logged in user
  const { user } = useUser()


  // ðŸ‘‰ This `useEffect` will wait for the user object to be loaded before requesting
  // the tasks for the logged in user
  useEffect(() => {
    if(!user) return
    async function loadTasks() {
      const { data, error } = await client.from("tasks").select();
      if (!error) setTasks(data);
    }
    loadTasks()
  }, [user])

  async function createTask(e: React.FormEvent<HTMLFormElement>) {
    e.preventDefault()
    // ðŸ‘‰ Insert task into the "tasks" database
    await client.from("tasks").insert({
      name
    });
    window.location.reload()
  }

  async function onCheckClicked(taskId: number, isDone: boolean) {
    // ðŸ‘‰ Update a task when its completed
    await client.from("tasks").update({
      is_done: isDone
    }).eq("id", taskId)
    window.location.reload()
  }

  async function deleteTask(taskId: number) {
    // ðŸ‘‰ Delete a task from the database
    await client.from("tasks").delete().eq("id", taskId)
    window.location.reload()
  }

  return (
    <div className='flex flex-col'>
      <form onSubmit={createTask} className='flex gap-2'>
        <Input
          autoFocus
          type='text'
          name='name'
          placeholder='What do you need to do?'
          onChange={e => setName(e.target.value)}
          value={name} />
        <Button type='submit' className='disabled:cursor-not-allowed'>Add</Button>
      </form>
      <div className='flex flex-col gap-2 p-2'>
        {tasks.map((task: any) => (
          <div key={task.id} className={`group flex items-center transition-all w-full${task.is_done ? 'text-slate-500' : ''}`}>
            <Button
              variant='link'
              className='text-lg text-inherit disabled:cursor-not-allowed'
              onClick={() => onCheckClicked(task.id, !task.is_done)}>
              { task.is_done ? <FiCheckCircle /> : <FiCircle /> }
            </Button>
            {task.name}
            <Button
              variant='link'
              className='text-lg text-inherit hover:text-red-500'
              onClick={() => deleteTask(task.id)}>
              <DeleteIcon />
            </Button>
          </div>
        ))}
      </div>
    </div>
  );
}
```

### Test the project

Now that the project is started, you can walk through
1. Create a file in the root of the project named `.env.local`.
1. Find your Clerk publishable key and secret key. If you're signed into Clerk, the `.env.local` snippet below will contain your keys. Otherwise:
    - Navigate to your Clerk Dashboard.
    - Select your application, then select **API Keys** in the sidebar menu.
    - You can copy your keys from the **Quick Copy** section.
1. Add your keys to your `.env.local` file.
1. Find your Supabase credentials:
    - Go to your Supabase dashboard. In the sidebar, select **Settings** > **API**.
    - Copy the **Project URL** and add it to your `.env.local` file.
    - Copy the value beside `anon` `public` in the **Project API Keys** section and add it to your `.env.local` file.

The final result should be similar to this:

    ```js filename=".env.local"
    CLERK_SECRET_KEY={{secret}}
    NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY={{pub_key}}
    NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
    NEXT_PUBLIC_SUPABASE_KEY=your_supabase_anon_key
    ```

1. Start the project with the following comamnd:

```bash
npm run dev
```

You should be able to access the project in your browser by navigating to the URL displayed in the terminal, where you will be prompted to create an account. By default this is `http://localhost:3000` but may differ if port `3000` is being used by another process on your machine.

To fully test the project, perform the following operations:

1. Test creating, completing, and deleting tasks from the user you're logged in with.
1. Log out and log in as a different user, the list of tasks should be blank. *
1. Test creating, completing, and deleting tasks from the new user.

* If you have the same tasks across multiple accounts, double check that RLS is enabled, or that the RLS policies were properly created.

If you analyze the table in the Supabase dashboard, you should see all tasks between both users, but with differing values in the `user_id` column.

</Steps>

## Next steps

- Try integrating Supabase into your own application by implementing RLS and leveraging the `createClerkSupabaseClient()` function and related code shown in this guide.
- Try adding some [custom claims](/docs/backend-requests/making/jwt-templates) to the JWT template in `app_metadata` or `user_metadata`.
